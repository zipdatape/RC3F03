# Control de Reinicios de Windows Update - An√°lisis y Soluci√≥n

**Fecha:** 12 de diciembre de 2025  
**Equipo:** HPERLAPPORTUGUE

---

## üîç DIAGN√ìSTICO: ¬øDe qu√© pol√≠tica GPO viene el reinicio?

### ‚ö†Ô∏è POL√çTICA GPO IDENTIFICADA

**Nombre de la Pol√≠tica:** `__WSUS`  
**GUID:** `673de858-cf21-426d-80f1-8b74c3801949`  
**√öltima modificaci√≥n:** 10 de octubre de 2025, 13:05:10  
**Estado:** Habilitada (AllSettingsEnabled)  
**Dominio:** ADPER.HITSS.MX

### Configuraci√≥n Actual Detectada

Basado en el an√°lisis del registro y pol√≠ticas de grupo, tu equipo tiene las siguientes pol√≠ticas aplicadas:

#### Pol√≠ticas de Windows Update (GPO)
**Ruta del registro:** `HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU`  
**Pol√≠tica aplicada:** `__WSUS`

| Par√°metro | Valor Actual | Significado | Pol√≠tica |
|-----------|--------------|-------------|----------|
| **AUOptions** | `7` | **Descargar e instalar autom√°ticamente, luego reiniciar autom√°ticamente** | **__WSUS** |
| **ScheduledInstallDay** | `7` | Todos los d√≠as | **__WSUS** |
| **ScheduledInstallTime** | `3` | **3:00 AM** (hora de instalaci√≥n) | **__WSUS** |
| **RebootRelaunchTimeout** | `10` | 10 minutos de espera antes de reiniciar | **__WSUS** |
| **UseWUServer** | `1` | Usa servidor WSUS: `wsus.adper.hitss.mx:8530` | **__WSUS** |
| **AutoInstallMinorUpdates** | `1` | Instalar actualizaciones menores autom√°ticamente | **__WSUS** |
| **NoAutoUpdate** | `0` | Actualizaciones autom√°ticas habilitadas | **__WSUS** |

### Pol√≠tica GPO Aplicada

La pol√≠tica que est√° causando los reinicios autom√°ticos es:

**Nombre:** `__WSUS`  
**Ruta en GPO:**  
`Computer Configuration > Administrative Templates > Windows Components > Windows Update > Configure Automatic Updates`

**Configuraci√≥n actual:**
- **Estado:** Habilitado
- **Opciones:** `7` = "Auto download, schedule install, and auto restart"
- **Horario programado:** Todos los d√≠as a las 3:00 AM
- **Servidor WSUS:** `wsus.adper.hitss.mx:8530`

**Para modificar esta pol√≠tica:**
1. Abrir **Administraci√≥n de directivas de grupo** (gpmc.msc)
2. Buscar la pol√≠tica: **`__WSUS`**
3. Navegar a: `Computer Configuration > Administrative Templates > Windows Components > Windows Update`
4. Modificar: **"Configure Automatic Updates"**

---

## ‚öôÔ∏è C√ìMO CONTROLAR EL HORARIO DE REINICIO

### Opci√≥n 1: Modificar la Pol√≠tica de Grupo (Recomendado para dominio)

Si tienes acceso al servidor de pol√≠ticas de grupo:

#### Paso 1: Abrir Editor de Pol√≠ticas de Grupo
1. Abre **Administraci√≥n de directivas de grupo** (gpmc.msc)
2. **Buscar la pol√≠tica:** `__WSUS` (GUID: 673de858-cf21-426d-80f1-8b74c3801949)
3. Navega a: `Computer Configuration > Administrative Templates > Windows Components > Windows Update`

#### Paso 2: Configurar "Configure Automatic Updates"
1. Haz doble clic en **"Configure Automatic Updates"**
2. Selecciona **"Enabled"**
3. En **"Configure automatic updating"**, selecciona una de estas opciones:

   | Opci√≥n | Descripci√≥n |
   |--------|-------------|
   | **2** | Notificar antes de descargar |
   | **3** | Descargar autom√°ticamente y notificar antes de instalar |
   | **4** | **Descargar autom√°ticamente e instalar en horario programado** (recomendado) |
   | **5** | Permitir al administrador local elegir |

4. Si eliges la opci√≥n **4**, configura:
   - **Scheduled install day:** 
     - `0` = Todos los d√≠as
     - `1-7` = Domingo a S√°bado
     - `8` = Solo los d√≠as laborables
   - **Scheduled install time:** 
     - `0-23` = Hora en formato 24 horas (ej: `22` = 10:00 PM)

#### Paso 3: Configurar "No auto-restart with logged on users"
1. Busca: **"No auto-restart for logged-on users"**
2. Selecciona **"Enabled"** para evitar reinicios cuando hay usuarios conectados

#### Paso 4: Configurar "Turn off auto-restart for updates during active hours"
1. Busca: **"Turn off auto-restart for updates during active hours"**
2. Selecciona **"Enabled"**
3. Configura las horas activas (ej: 8:00 AM - 6:00 PM)

### Opci√≥n 2: Modificar Registro Localmente (Solo para este equipo)

Si no tienes acceso a GPO o quieres una soluci√≥n temporal:

#### Script PowerShell para Cambiar Horario

```powershell
# Script: Cambiar-HorarioReinicioWindowsUpdate.ps1
# Ejecutar como Administrador

param(
    [Parameter(Mandatory=$false)]
    [int]$HoraInstalacion = 22,  # 10:00 PM por defecto
    
    [Parameter(Mandatory=$false)]
    [int]$DiaInstalacion = 0,     # 0 = Todos los d√≠as, 1-7 = Domingo-S√°bado
    
    [Parameter(Mandatory=$false)]
    [int]$MinutosEsperaReinicio = 30  # 30 minutos antes de reiniciar
)

Write-Host "=== CONFIGURANDO HORARIO DE REINICIO DE WINDOWS UPDATE ===" -ForegroundColor Cyan

# Verificar permisos de administrador
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
if (-not $isAdmin) {
    Write-Error "Este script requiere permisos de administrador"
    exit 1
}

# Ruta del registro
$auPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU"

# Verificar si existe la ruta
if (!(Test-Path $auPath)) {
    Write-Host "Creando ruta de registro..." -ForegroundColor Yellow
    New-Item -Path $auPath -Force | Out-Null
}

# Validar hora (0-23)
if ($HoraInstalacion -lt 0 -or $HoraInstalacion -gt 23) {
    Write-Error "La hora debe estar entre 0 y 23"
    exit 1
}

# Validar d√≠a (0-8)
if ($DiaInstalacion -lt 0 -or $DiaInstalacion -gt 8) {
    Write-Error "El d√≠a debe estar entre 0 (todos) y 8 (laborables)"
    exit 1
}

try {
    # Cambiar horario de instalaci√≥n
    Write-Host "Configurando horario de instalaci√≥n: $HoraInstalacion:00" -ForegroundColor Yellow
    Set-ItemProperty -Path $auPath -Name "ScheduledInstallTime" -Value $HoraInstalacion -Type DWord -ErrorAction Stop
    
    # Cambiar d√≠a de instalaci√≥n
    $diaTexto = switch ($DiaInstalacion) {
        0 { "Todos los d√≠as" }
        1 { "Domingo" }
        2 { "Lunes" }
        3 { "Martes" }
        4 { "Mi√©rcoles" }
        5 { "Jueves" }
        6 { "Viernes" }
        7 { "S√°bado" }
        8 { "D√≠as laborables" }
    }
    Write-Host "Configurando d√≠a de instalaci√≥n: $diaTexto" -ForegroundColor Yellow
    Set-ItemProperty -Path $auPath -Name "ScheduledInstallDay" -Value $DiaInstalacion -Type DWord -ErrorAction Stop
    
    # Cambiar tiempo de espera antes de reiniciar (en minutos)
    Write-Host "Configurando tiempo de espera antes de reiniciar: $MinutosEsperaReinicio minutos" -ForegroundColor Yellow
    Set-ItemProperty -Path $auPath -Name "RebootRelaunchTimeout" -Value $MinutosEsperaReinicio -Type DWord -ErrorAction Stop
    Set-ItemProperty -Path $auPath -Name "RebootRelaunchTimeoutEnabled" -Value 1 -Type DWord -ErrorAction Stop
    
    # Cambiar AUOptions a 4 (instalar en horario programado, no reiniciar inmediatamente)
    Write-Host "Cambiando modo de actualizaci√≥n a 'Instalar en horario programado'" -ForegroundColor Yellow
    Set-ItemProperty -Path $auPath -Name "AUOptions" -Value 4 -Type DWord -ErrorAction Stop
    
    Write-Host "`nConfiguraci√≥n aplicada exitosamente!" -ForegroundColor Green
    Write-Host "Horario de instalaci√≥n: $HoraInstalacion:00" -ForegroundColor Green
    Write-Host "D√≠a: $diaTexto" -ForegroundColor Green
    Write-Host "Tiempo de espera antes de reiniciar: $MinutosEsperaReinicio minutos" -ForegroundColor Green
    
    # Reiniciar servicio Windows Update
    Write-Host "`nReiniciando servicio Windows Update..." -ForegroundColor Yellow
    Restart-Service wuauserv -Force
    
    Write-Host "`n¬°Configuraci√≥n completada!" -ForegroundColor Green
    
} catch {
    Write-Error "Error al aplicar configuraci√≥n: $($_.Exception.Message)"
    exit 1
}
```

#### Uso del Script

```powershell
# Ejecutar como Administrador

# Cambiar a 10:00 PM todos los d√≠as
.\Cambiar-HorarioReinicioWindowsUpdate.ps1 -HoraInstalacion 22

# Cambiar a 11:00 PM solo los s√°bados
.\Cambiar-HorarioReinicioWindowsUpdate.ps1 -HoraInstalacion 23 -DiaInstalacion 7

# Cambiar a 2:00 AM d√≠as laborables con 60 minutos de espera
.\Cambiar-HorarioReinicioWindowsUpdate.ps1 -HoraInstalacion 2 -DiaInstalacion 8 -MinutosEsperaReinicio 60
```

### Opci√≥n 3: Configurar Horarios Activos

Los horarios activos evitan que Windows reinicie durante las horas que especifiques:

```powershell
# Configurar horarios activos (8:00 AM - 6:00 PM)
$uxPath = "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\Settings"

if (!(Test-Path $uxPath)) {
    New-Item -Path $uxPath -Force | Out-Null
}

# Horario activo: 8:00 AM (8) a 6:00 PM (18)
Set-ItemProperty -Path $uxPath -Name "ActiveHoursStart" -Value 8 -Type DWord
Set-ItemProperty -Path $uxPath -Name "ActiveHoursEnd" -Value 18 -Type DWord
Set-ItemProperty -Path $uxPath -Name "IsActiveHoursEnabled" -Value 1 -Type DWord
Set-ItemProperty -Path $uxPath -Name "ActiveHoursMaxRange" -Value 12 -Type DWord
```

---

## üìã VALORES DE CONFIGURACI√ìN

### AUOptions (Modo de Actualizaci√≥n)

| Valor | Descripci√≥n |
|-------|-------------|
| 2 | Notificar antes de descargar |
| 3 | Descargar autom√°ticamente y notificar antes de instalar |
| 4 | **Descargar autom√°ticamente e instalar en horario programado** ‚≠ê Recomendado |
| 5 | Permitir al administrador local elegir |
| 7 | Descargar e instalar autom√°ticamente, luego reiniciar autom√°ticamente (actual) |

### ScheduledInstallDay (D√≠a de Instalaci√≥n)

| Valor | D√≠a |
|-------|-----|
| 0 | Todos los d√≠as |
| 1 | Domingo |
| 2 | Lunes |
| 3 | Martes |
| 4 | Mi√©rcoles |
| 5 | Jueves |
| 6 | Viernes |
| 7 | S√°bado |
| 8 | Solo d√≠as laborables |

### ScheduledInstallTime (Hora de Instalaci√≥n)

| Valor | Hora |
|-------|------|
| 0-23 | Hora en formato 24 horas (0 = medianoche, 23 = 11 PM) |

---

## üîß VERIFICAR CONFIGURACI√ìN ACTUAL

```powershell
# Ver configuraci√≥n actual
$au = Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" -ErrorAction SilentlyContinue

if ($au) {
    Write-Host "=== CONFIGURACI√ìN ACTUAL ===" -ForegroundColor Cyan
    Write-Host "AUOptions: $($au.AUOptions)"
    Write-Host "ScheduledInstallDay: $($au.ScheduledInstallDay)"
    Write-Host "ScheduledInstallTime: $($au.ScheduledInstallTime):00"
    Write-Host "RebootRelaunchTimeout: $($au.RebootRelaunchTimeout) minutos"
    Write-Host "UseWUServer: $($au.UseWUServer)"
} else {
    Write-Host "No hay pol√≠ticas de GPO aplicadas" -ForegroundColor Yellow
}
```

---

## ‚ö†Ô∏è IMPORTANTE

1. **Si modificas el registro localmente:**
   - Los cambios pueden ser sobrescritos por GPO en el pr√≥ximo refresh
   - Ejecuta `gpupdate /force` despu√©s de modificar GPO
   - Reinicia el servicio: `Restart-Service wuauserv -Force`

2. **Para cambios permanentes:**
   - Modifica la pol√≠tica de grupo en el servidor
   - Los cambios se aplicar√°n a todos los equipos del dominio/OU

3. **Recomendaciones de horario:**
   - Horas de menor uso: 10:00 PM - 2:00 AM
   - D√≠as: S√°bados o domingos para actualizaciones grandes
   - Configurar horarios activos para evitar interrupciones

---

## üìù RESUMEN DE LA SOLUCI√ìN

**Problema actual:**
- Reinicios autom√°ticos a las 3:00 AM todos los d√≠as
- Causado por `AUOptions = 7` (reinicio autom√°tico inmediato)

**Soluci√≥n recomendada:**
1. Cambiar `AUOptions` de `7` a `4` (instalar en horario programado)
2. Cambiar `ScheduledInstallTime` a una hora m√°s conveniente (ej: 22 = 10:00 PM)
3. Configurar horarios activos (8:00 AM - 6:00 PM)
4. Aumentar `RebootRelaunchTimeout` a 30-60 minutos

**Pr√≥ximos pasos:**
1. Identificar la pol√≠tica GPO en el servidor
2. Modificar la pol√≠tica o aplicar cambios locales
3. Verificar que los cambios se aplicaron correctamente
4. Monitorear los pr√≥ximos reinicios

---

**Generado:** 12 de diciembre de 2025

